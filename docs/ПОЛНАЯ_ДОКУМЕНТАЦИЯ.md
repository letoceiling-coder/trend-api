# Полная документация проекта TrendAgent

Понятное руководство: откуда берутся данные, как и когда они обновляются, как пользоваться сайтом и где смотреть последние обновления.

---

## 1. Что это за проект и откуда данные

**Сайт:** https://trendagent.siteaccess.ru

Проект **не парсит страницы** вручную. Он получает данные через **официальные API сервиса TrendAgent** (api.trendagent.ru и др.): списки жилых комплексов (блоков), квартир, детальные карточки. Эти данные сохраняются в нашу базу и отображаются на нашем сайте.

- **Источник данных:** внешний сервис TrendAgent (нужна авторизация SSO).
- **Наш сервер:** забирает данные по расписанию и по запросу, сохраняет в таблицы `ta_blocks`, `ta_apartments`, `ta_block_details`, `ta_apartment_details` и др.
- **Наш интерфейс:** показывает только то, что уже загружено в нашу базу.

---

## 2. Регионы (города): по какому региону парсятся объекты

Понятие «регион» в API TrendAgent — это **город**, он задаётся параметром **`city_id`** (и при необходимости языком **`lang`**, обычно `ru`).

### Какой регион парсится сейчас

- По умолчанию используется **один** город из настроек сервера: переменная **`TRENDAGENT_DEFAULT_CITY_ID`** в файле `.env` на сервере.
- Все автоматические задачи (расписание) и ручной запуск «пайплайна» без указания города используют этот `city_id`.
- Пример: для Санкт-Петербурга в TrendAgent обычно используется свой `city_id` (значение задаётся в .env; точный код города можно посмотреть в документации или в запросах на spb.trendagent.ru).

### Как парсить другой регион

1. **Узнать `city_id`** нужного города в API TrendAgent (из их документации или запросов с их сайта).
2. **Вариант А — сменить регион по умолчанию:**  
   На сервере в `/var/www/trend-api/backend/.env` задать:
   ```env
   TRENDAGENT_DEFAULT_CITY_ID=нужный_city_id
   TRENDAGENT_DEFAULT_LANG=ru
   ```
   После этого выполнить:  
   `php artisan config:clear`  
   Дальше по расписанию и при ручном запуске будет использоваться новый город.

3. **Вариант Б — разовый запуск по другому городу:**  
   Через API админки можно запустить пайплайн с нужным городом (см. раздел 4).  
   Либо на сервере вручную:
   ```bash
   php artisan trendagent:dispatch:blocks --city=ДРУГОЙ_CITY_ID --lang=ru
   php artisan trendagent:dispatch:apartments --city=ДРУГОЙ_CITY_ID --lang=ru
   ```

Данные в базе хранятся **по парам (city_id, lang)**: один и тот же блок или квартира могут быть для разных городов; в интерфейсе по умолчанию отображаются данные для того города, для которого загружены записи (сейчас — для `TRENDAGENT_DEFAULT_CITY_ID`).

---

## 3. Когда и как парсятся (обновляются) объекты

Обновление данных идёт в два уровня: **списки** (комплексы и квартиры) и **детальные карточки** (блоков и квартир).

### Автоматическое расписание (на сервере)

На сервере настроен **cron**: раз в минуту выполняется `php artisan schedule:run`. Внутри расписания Laravel задано:

| Что запускается | Как часто | Что делает |
|-----------------|-----------|------------|
| Список комплексов (blocks) | Каждые **15 минут** | По **каждому региону** из таблицы `ta_cities`: запрашивает список ЖК, сохраняет в `ta_blocks`, ставит в очередь задачи на детали. Если `ta_cities` пуста — используется один регион из `TRENDAGENT_DEFAULT_CITY_ID`. |
| Список квартир (apartments) | Каждые **15 минут** | Аналогично по всем регионам из `ta_cities` (или один из .env). |
| Детали блоков (устаревшие/незаполненные) | **Раз в час** | Догружает детали по блокам **всех городов**, у которых их нет или они устарели. |
| Детали квартир (устаревшие/незаполненные) | **Раз в час** | То же для квартир по всем городам. |
| Проверка алертов (ошибки синка, качество) | Каждые **5 минут** | При настроенных Telegram-токенах отправляет уведомления о сбоях. |

**Регионы для парсинга:** берутся из таблицы **`ta_cities`** (ключ `city_id`, название). Чтобы заполнить список регионов один раз: `php artisan trendagent:seed-cities` (подставит Москву, СПб, Краснодар, Ростов, Крым, Казань, Уфу, Екатеринбург, Новосибирск, ОАЭ). Язык по умолчанию — `TRENDAGENT_DEFAULT_LANG` (обычно `ru`).

### Ручной запуск обновления (пайплайн)

Можно один раз запустить полный цикл для выбранного города и языка:

- **Через интерфейс:** страница **«Админка TA»** (см. раздел 5) — кнопка запуска пайплайна, там же можно задать город и язык (если интерфейс это поддерживает).
- **Через API:**  
  `POST /api/ta/admin/pipeline/run`  
  с заголовком `X-Internal-Key: ваш_ключ` и телом, например:
  ```json
  {
    "city_id": "spb",
    "lang": "ru",
    "blocks_count": 50,
    "blocks_pages": 5,
    "apartments_pages": 10,
    "dispatch_details": true,
    "detail_limit": 50
  }
  ```
  Если `city_id` не передать, возьмётся `TRENDAGENT_DEFAULT_CITY_ID`. На 15 минут для пары (city_id, lang) ставится блокировка: повторный запуск вернёт 409, пока блокировка не истечёт.

Итог: **объекты по регионам парсятся** по расписанию (каждые 15 минут — списки, каждый час — догрузка деталей) для региона по умолчанию и при ручном запуске пайплайна — для указанного в запросе города.

### Почему парсер не работает: «TrendAgent SSO session is not available»

Если при запуске `ta:fill-all` или `trendagent:sync:blocks` все регионы падают с ошибкой **«TrendAgent SSO session is not available»**, значит на сервере **нет активной авторизации** в TrendAgent. API TrendAgent требует SSO-токен; без него запросы к API блокируются.

**Причина:** в таблице `ta_sso_sessions` нет активной записи с `refresh_token` (никто не выполнял вход на сервере или сессия истекла).

**Что сделать (один из способов):**

**Способ 1 — программный вход (телефон + пароль в .env, с авто-релогином):**

1. На сервере в файл **`/var/www/trend-api/backend/.env`** добавить (подставьте свой телефон и пароль от входа на spb.trendagent.ru / sso.trend.tech):
   ```env
   TRENDAGENT_DEFAULT_PHONE=+79XXXXXXXXX
   TRENDAGENT_DEFAULT_PASSWORD=ваш_пароль
   TRENDAGENT_DEFAULT_CITY_ID=58c665588b6aa52311afa01b
   TRENDAGENT_AUTO_RELOGIN=true
   ```
   Если заданы `TRENDAGENT_DEFAULT_PHONE` и `TRENDAGENT_DEFAULT_PASSWORD`, автоматический релогин при истечении сессии включается по умолчанию (переменную `TRENDAGENT_AUTO_RELOGIN=true` можно не указывать).

2. Обновить кэш конфига и один раз выполнить вход:
   ```bash
   cd /var/www/trend-api/backend
   php artisan config:clear
   php artisan trendagent:auth:login
   ```
   Если в выводе «TrendAgent SSO login successful» — сессия сохранена. Дальше можно запускать `php artisan ta:fill-all`. При истечении сессии парсер сам выполнит повторный вход по этим учётным данным (с ограничением по частоте).

**Способ 2 — сохранить refresh_token из браузера:**

1. Зайти на https://spb.trendagent.ru (или https://sso.trend.tech) и войти в аккаунт.
2. В DevTools браузера: Application → Cookies → скопировать значение cookie **refresh_token**.
3. На сервере в `.env` задать `TRENDAGENT_DEFAULT_PHONE` (номер, под которым вы вошли).
4. Выполнить:
   ```bash
   php artisan trendagent:auth:save-refresh "ВСТАВЬТЕ_СЮДА_СКОПИРОВАННЫЙ_ТОКЕН"
   ```

После успешного сохранения сессии проверка: `php artisan trendagent:auth:check` — должен показать, что сессия активна. Затем снова запустить `php artisan ta:fill-all`.

**Автоповтор входа при истечении сессии:** если задать в .env `TRENDAGENT_AUTO_RELOGIN=true` и указать `TRENDAGENT_DEFAULT_PHONE` и `TRENDAGENT_DEFAULT_PASSWORD`, при падении сессии приложение попытается один раз выполнить вход заново (с ограничениями по частоте).

---

### Почему в БД может быть 0 записей (прочие причины)

Если SSO-сессия есть, но `ta:stats` по-прежнему 0:

1. **Не задан город** — в `.env` задать `TRENDAGENT_DEFAULT_CITY_ID` или заполнить `ta_cities` командой `php artisan trendagent:seed-cities`.
2. **Расписание не запускается** — cron должен каждую минуту вызывать `php artisan schedule:run`.
3. **Очередь не обрабатывается** — при `QUEUE_CONNECTION=redis` должен быть запущен воркер: `php artisan queue:work redis --queue=default`.
4. **Синк ни разу не выполнялся** — после создания SSO-сессии один раз запустить `php artisan ta:fill-all` или пайплайн.

### Как срочно заполнить БД вручную (разовый запуск)

Выполнить **на сервере** в каталоге `/var/www/trend-api/backend`:

**Вариант А — одна команда (синк в текущем процессе, без очереди):**
```bash
php artisan ta:fill
```
Команда подставит город и язык из `.env`, загрузит списки блоков и квартир в БД. Детали можно догрузить потом (см. ниже) или запустить пайплайн.

**Вариант В — по шагам (один город вручную):**
```bash
# Списки комплексов и квартир (пишут сразу в БД)
php artisan trendagent:sync:blocks --city=ВАШ_CITY_ID --lang=ru --max-pages=10
php artisan trendagent:sync:apartments --city=ВАШ_CITY_ID --lang=ru --max-pages=5
```
Замените `ВАШ_CITY_ID` на значение из `TRENDAGENT_DEFAULT_CITY_ID` или нужный город.

**Вариант В — через API пайплайн** (если на сервере в `.env` стоит `QUEUE_CONNECTION=sync`, пайплайн выполнится в рамках запроса и сразу заполнит БД):
```bash
curl -X POST -H "X-Internal-Key: ВАШ_КЛЮЧ" -H "Content-Type: application/json" \
  -d '{"city_id":"ВАШ_CITY_ID","lang":"ru","blocks_pages":5,"apartments_pages":5,"dispatch_details":true}' \
  https://trendagent.siteaccess.ru/api/ta/admin/pipeline/run
```

После первого заполнения проверка: `php artisan ta:stats` — должны появиться ненулевые значения по блокам и квартирам.

### Что проверить для постоянной работы парсера

| Проверка | Действие |
|----------|----------|
| **SSO-сессия** | **Сначала:** создать сессию — `php artisan trendagent:auth:login` (нужны TRENDAGENT_DEFAULT_PHONE и TRENDAGENT_DEFAULT_PASSWORD в .env) или `trendagent:auth:save-refresh "<refresh_token>"`. Проверка: `php artisan trendagent:auth:check`. Без активной сессии ошибка «SSO session is not available». |
| Город в .env | В `backend/.env`: `TRENDAGENT_DEFAULT_CITY_ID=...` (или заполнить `ta_cities`: `php artisan trendagent:seed-cities`), затем `php artisan config:clear`. |
| Cron | В crontab: `* * * * * cd /var/www/trend-api/backend && php artisan schedule:run >> /dev/null 2>&1`. |
| Воркер очереди | При `QUEUE_CONNECTION=redis`: запустить `php artisan queue:work redis --queue=default`. Статус: `php artisan ta:smoke` (поле `queue_ok`). |

---

## 4. Возможности и функционал системы

### Какие объекты есть

- **Жилые комплексы (блоки)** — список, карточка, детали (описание, преимущества, банк, карта, цены и т.д.).
- **Квартиры** — список/таблица, карточка квартиры, детали (планировки, цены).
- **Справочники** — типы комнат, сроки сдачи, метро, отделки и т.п. (для фильтров и подсказок).
- **Единицы измерения** — для цен и площадей.

Парковки, посёлки, коммерция в оригинальном TrendAgent есть, но в **текущем** нашем интерфейсе могут быть не реализованы или частично.

### Что умеет бэкенд

- Синхронизация списков блоков и квартир с API TrendAgent по `city_id` и `lang`.
- Догрузка деталей по каждому блоку и квартире (в фоне, через очередь).
- Хранение сырых ответов API (при необходимости) и нормализованных полей для выдачи в нашем API.
- Очередь задач (Redis): фоновые задачи не блокируют веб-запросы.
- Алерты в Telegram при сбоях синка и ухудшении качества (если настроены токены в .env).
- Проверка «здоровья»: последний успешный синк, очередь, Redis, расписание (эндпоинт health).

### Что умеет интерфейс

- Просмотр списка комплексов, таблицы квартир, карты, планировок.
- Открытие карточки комплекса и карточки квартиры.
- Шахматка по этажам/секциям для выбранного корпуса.
- Админка: здоровье, последние запуски синка, ручной запуск пайплайна, просмотр sync runs (когда что последний раз обновлялось).

---

## 5. Как пользоваться интерфейсом

Сайт: **https://trendagent.siteaccess.ru**

### Основное меню

- **Home (Главная)** — стартовая страница.
- **Объекты** — переход к списку комплексов.
- **HealthCheck** — проверка, что API отвечает.
- **Admin TA** — админ-панель (health, синки, запуск пайплайна); для части действий нужен внутренний ключ (см. ниже).

### Страницы для просмотра объектов

| Страница | Адрес | Что смотреть |
|----------|--------|---------------|
| Список комплексов | `/objects/list` | Карточки ЖК: название, адрес, цена, срок сдачи. Можно переходить в карточку комплекса. |
| Таблица квартир | `/objects/table` | Таблица квартир с основными полями (цена, комнаты, площадь и т.д.). |
| Карта | `/objects/map` | Комплексы на карте (если есть координаты в данных). |
| Планировки | `/objects/plans` | Сетка планировок квартир. |
| Карточка комплекса | `/object/{block_id}` | Подставьте `block_id` из списка. Вкладки: о комплексе, преимущества, рядом, банк, карта, цены, квартиры, документы. |
| Карточка квартиры | `/flat/{apartment_id}` | Детали квартиры: планировка, цены, комплекс. |
| Шахматка по корпусу | `/object/{block_id}/checkerboard` | Сетка «этаж × секция» с ячейками квартир. |

Фильтры и поиск на страницах работают по уже загруженным данным из нашей базы.

### Админка TA (`/admin/ta`)

- **Health** — состояние: последний успешный синк по типам (blocks, apartments, block_detail, apartment_detail), очередь, Redis, расписание. Показывает, «жива» ли система и когда в последний раз что обновлялось.
- **Sync runs** — список последних запусков синхронизации: что запускалось, успех/ошибка, сколько записей обработано.
- **Pipeline run** — ручной запуск пайплайна (город, язык, количество страниц). Нужен **внутренний ключ** (см. ниже).
- **Coverage** — сколько блоков и квартир в базе, сколько с деталями.
- При необходимости здесь же можно обновить один блок или одну квартиру по ID (если в интерфейсе есть поля для ввода ID и кнопки «Обновить»).

Для доступа к запуску пайплайна и к части данных в админке в интерфейсе может потребоваться ввести **внутренний ключ** — это значение `INTERNAL_API_KEY` из `.env` на сервере (ключ не показывается в интерфейсе и не должен светиться в публичной документации).

---

## 6. Как смотреть последние обновления

### В интерфейсе

1. **Админка TA** → блок **Health**:
   - Поля вида «последний успешный синк» по scope (blocks, apartments, block_detail, apartment_detail) показывают **время последнего успешного** обновления по каждому типу.
2. **Админка TA** → **Sync runs**:
   - Таблица последних запусков: дата/время, тип (blocks/apartments/…), статус (success/failed), количество записей. По ним видно, когда что последний раз парсилось и не было ли ошибок.

### Через API (для скриптов или мониторинга)

- **GET** `/api/ta/admin/health`  
  Заголовок: `X-Internal-Key: ваш_ключ`  
  В ответе — сводка по последним успешным синкам, очереди, Redis, счётчикам за 24 часа.

- **GET** `/api/ta/admin/sync-runs`  
  С тем же заголовком. Параметры: `since_hours=24`, `status=success` или `failed`, `limit=50` и т.д. Список последних запусков синхронизации — по ним видно, когда были последние обновления.

Данные на сайте (списки и карточки) соответствуют тому, что уже загружено в базу на момент запроса; «свежесть» лучше всего смотреть по Health и Sync runs.

---

## 7. Краткая шпаргалка

| Вопрос | Ответ |
|--------|--------|
| Откуда данные? | API TrendAgent (api.trendagent.ru и др.), не парсинг HTML. |
| По какому региону парсятся объекты? | По умолчанию — город из `TRENDAGENT_DEFAULT_CITY_ID` в .env. Другой регион — через ручной запуск с `city_id` или смена переменной. |
| Когда обновляются списки? | Каждые 15 минут (blocks и apartments) по расписанию. |
| Когда догружаются детали? | После каждого синка списков ставятся задачи в очередь; плюс раз в час — догрузка устаревших/незаполненных деталей. |
| Как запустить обновление вручную? | Все регионы: `php artisan trendagent:seed-cities` затем `php artisan ta:fill-all`. Один регион: `php artisan ta:fill` или Админка TA → Pipeline run, или API `POST /api/ta/admin/pipeline/run`. |
| По каким регионам идёт парсинг? | По всем из таблицы `ta_cities`. Если таблица пуста — по одному региону из `TRENDAGENT_DEFAULT_CITY_ID`. Список регионов: `php artisan trendagent:seed-cities`. |
| Где смотреть ошибки парсера? | `storage/logs/laravel.log`: при падении синка пишется запись с scope, city_id, lang, run_id, error_message. Сводка по регионам в конце вывода `ta:fill-all`. |
| Ошибка «SSO session is not available»? | На сервере нет входа в TrendAgent. Выполнить один раз: `php artisan trendagent:auth:login` (в .env задать TRENDAGENT_DEFAULT_PHONE и TRENDAGENT_DEFAULT_PASSWORD) или сохранить токен из браузера: `trendagent:auth:save-refresh "<token>"`. См. раздел 3. |
| Почему в БД 0 записей? | Чаще всего — нет SSO-сессии (см. выше). Иначе: не задан город / не заполнена ta_cities, не запущен cron/воркер, синк не запускали. |
| Где смотреть последние обновления? | Админка TA → Health (время последнего успешного синка по типам) и Sync runs (список последних запусков). |
| Как пользоваться сайтом? | Объекты → список/таблица/карта/планировки; клик по карточке → детали; Админка TA — для здоровья и ручного запуска. |

Дополнительные технические детали (команды artisan, структура API, деплой) — в `backend/docs/trendagent/` (PROD_RUNBOOK.md, PROJECT_URLS.md, HOW_IT_WORKS_AND_VIEW.md и др.).
